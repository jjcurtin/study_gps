---
title: "EDA of CHTC features - Cleaning"
author: "Claire Punturieri"
date: "`r lubridate::today()`"
format: 
  html:
    toc: true
    toc_depth: 4
    embed-resources: true
editor_options: 
  chunk_output_type: console
params:
  window: "day"
  roll_dur: 1 # 1 24
  sample: "gps" # ema messages
---

# Housekeeping

## Code Status


## Notes

 - Maximum of rate sum features should probably be 1 for raw features? If we are calculating a rate that is the total amount of time in that period at a given location divided by the total amount of time in a period, logically that value cannot be over 1. Maybe for GPS data we need to drop the first row in a given period, because duration is the amount of time that has passed since the previous point.


# Set up

## Set up environment basics

```{r}
#| message: false
#| warning: false

library(tidyverse)
library(tidymodels)

options(conflicts.policy = "depends.ok")
```

## Paths

```{r}
source("https://github.com/jjcurtin/lab_support/blob/main/format_path.R?raw=true")

name_job <- str_c("features_", params$sample, "_", params$window, "_", params$roll_dur, "h")

path_chtc <- format_path(str_c("risk/chtc/shared/features_gps/", name_job, "/output"))
path_shared <- format_path("risk/data_processed/shared")
features_file <- str_c("batch_features.csv")
```

## Additional packages and source

```{r}
#| message: false
#| warning: false
#| echo: false

# for data wrangling
library(skimr)

# helpful lab functions
source("https://github.com/jjcurtin/lab_support/blob/main/fun_eda.R?raw=true")

# adjust plot visuals
theme_set(theme_classic())
options(tibble.width = Inf, dplyr.print_max = Inf)
```

## Load in data

```{r}
features <- read_csv(here::here(path_chtc, features_file), 
                 show_col_types = FALSE)
```

# EDA - Cleaning

Verify percentage of lapses looks reasonable.
```{r}
features |> 
  janitor::tabyl(lapse)
```

Overview across all categories.
```{r}
features |>  
  skimr::skim_without_charts() |> 
  select(skim_variable, n_missing, complete_rate, numeric.p0, numeric.p50, 
         numeric.p100) |>
  filter(!skim_variable == "subid" & !skim_variable == "label_num") |> 
  arrange(desc(numeric.p100), skim_variable) 
```

```{r}
features |> glimpse()
```

```{r}
features |>
  skimr::skim_without_charts() |> 
  select(skim_variable, numeric.p0, numeric.p100, numeric.sd, complete_rate)
```

Check raw scores (numeric.p0 should = 0).
```{r}
features |>  
  skimr::skim_without_charts() |> 
  select(skim_variable, n_missing, complete_rate, numeric.p0, numeric.p50, 
         numeric.p100) |>
  filter(!skim_variable == "subid" & !skim_variable == "label_num") |>
  filter(grepl("rrate|rvar", skim_variable)) |> 
  arrange(desc(numeric.p0), skim_variable)
```

Check difference scores (numeric.p0 can be less than 0)
```{r}
features |>  
  skimr::skim_without_charts() |> 
  select(skim_variable, n_missing, complete_rate, numeric.p0, numeric.p50, 
         numeric.p100) |>
  filter(!skim_variable == "subid" & !skim_variable == "label_num") |>
  filter(grepl("drate|dvar", skim_variable)) |> 
  arrange(desc(numeric.p0), skim_variable)
```

Location variance scores, sorted by missingness.
```{r}
features |>  
  skimr::skim_without_charts() |> 
  select(skim_variable, n_missing, complete_rate, numeric.p0, numeric.p50, 
         numeric.p100) |>
  filter(!skim_variable == "subid" & !skim_variable == "label_num") |>
  filter(grepl("rvar|dvar", skim_variable)) |> 
  arrange(desc(n_missing), skim_variable)
```

## Correlations between contextual features

Sanity check that calculations are correct, features should be at least somewhat inversely correlated.

### Alcohol
```{r}
cor_table <- data.frame(
  period = c("6h", "12h", "24h", "48h", "72h", "168h"),
  correlation = c(
    cor(features$p6.l0.rratesum_duration.alcohol.yes, features$p6.l0.rratesum_duration.alcohol.no),
    cor(features$p12.l0.rratesum_duration.alcohol.yes, features$p12.l0.rratesum_duration.alcohol.no),
    cor(features$p24.l0.rratesum_duration.alcohol.yes, features$p24.l0.rratesum_duration.alcohol.no),
    cor(features$p48.l0.rratesum_duration.alcohol.yes, features$p48.l0.rratesum_duration.alcohol.no),
    cor(features$p72.l0.rratesum_duration.alcohol.yes, features$p72.l0.rratesum_duration.alcohol.no),
    cor(features$p168.l0.rratesum_duration.alcohol.yes, features$p168.l0.rratesum_duration.alcohol.no)
  )
)

cat("Correlation between RAW 'alcohol.yes' and 'alcohol.no' rates\n\n")
print(cor_table)
```

```{r}
cor_table <- data.frame(
  period = c("6h", "12h", "24h", "48h", "72h", "168h"),
  correlation = c(
    cor(features$p6.l0.dratesum_duration.alcohol.yes, features$p6.l0.dratesum_duration.alcohol.no),
    cor(features$p12.l0.dratesum_duration.alcohol.yes, features$p12.l0.dratesum_duration.alcohol.no),
    cor(features$p24.l0.dratesum_duration.alcohol.yes, features$p24.l0.dratesum_duration.alcohol.no),
    cor(features$p48.l0.dratesum_duration.alcohol.yes, features$p48.l0.dratesum_duration.alcohol.no),
    cor(features$p72.l0.dratesum_duration.alcohol.yes, features$p72.l0.dratesum_duration.alcohol.no),
    cor(features$p168.l0.dratesum_duration.alcohol.yes, features$p168.l0.dratesum_duration.alcohol.no)
  )
)

cat("Correlation between DIFFERENCE 'alcohol.yes' and 'alcohol.no' rates\n\n")
print(cor_table)
```

### Drank
```{r}
cor_table <- data.frame(
  period = c("6h", "12h", "24h", "48h", "72h", "168h"),
  correlation = c(
    cor(features$p6.l0.rratesum_duration.drank.yes, features$p6.l0.rratesum_duration.drank.no),
    cor(features$p12.l0.rratesum_duration.drank.yes, features$p12.l0.rratesum_duration.drank.no),
    cor(features$p24.l0.rratesum_duration.drank.yes, features$p24.l0.rratesum_duration.drank.no),
    cor(features$p48.l0.rratesum_duration.drank.yes, features$p48.l0.rratesum_duration.drank.no),
    cor(features$p72.l0.rratesum_duration.drank.yes, features$p72.l0.rratesum_duration.drank.no),
    cor(features$p168.l0.rratesum_duration.drank.yes, features$p168.l0.rratesum_duration.drank.no)
  )
)

cat("Correlation between RAW 'drank.yes' and 'drank.no' rates\n\n")
print(cor_table)
```

```{r}
cor_table <- data.frame(
  period = c("6h", "12h", "24h", "48h", "72h", "168h"),
  correlation = c(
    cor(features$p6.l0.dratesum_duration.drank.yes, features$p6.l0.dratesum_duration.drank.no),
    cor(features$p12.l0.dratesum_duration.drank.yes, features$p12.l0.dratesum_duration.drank.no),
    cor(features$p24.l0.dratesum_duration.drank.yes, features$p24.l0.dratesum_duration.drank.no),
    cor(features$p48.l0.dratesum_duration.drank.yes, features$p48.l0.dratesum_duration.drank.no),
    cor(features$p72.l0.dratesum_duration.drank.yes, features$p72.l0.dratesum_duration.drank.no),
    cor(features$p168.l0.dratesum_duration.drank.yes, features$p168.l0.dratesum_duration.drank.no)
  )
)

cat("Correlation between DIFFERENCE 'drank.yes' and 'drank.no' rates\n\n")
print(cor_table)
```

### Avoid
```{r}
cor_table <- data.frame(
  period = c("6h", "12h", "24h", "48h", "72h", "168h"),
  correlation = c(
    cor(features$p6.l0.rratesum_duration.avoid.yes, features$p6.l0.rratesum_duration.avoid.no),
    cor(features$p12.l0.rratesum_duration.avoid.yes, features$p12.l0.rratesum_duration.avoid.no),
    cor(features$p24.l0.rratesum_duration.avoid.yes, features$p24.l0.rratesum_duration.avoid.no),
    cor(features$p48.l0.rratesum_duration.avoid.yes, features$p48.l0.rratesum_duration.avoid.no),
    cor(features$p72.l0.rratesum_duration.avoid.yes, features$p72.l0.rratesum_duration.avoid.no),
    cor(features$p168.l0.rratesum_duration.avoid.yes, features$p168.l0.rratesum_duration.avoid.no)
  )
)

cat("Correlation between RAW 'avoid.yes' and 'avoid.no' rates\n\n")
print(cor_table)
```

```{r}
cor_table <- data.frame(
  period = c("6h", "12h", "24h", "48h", "72h", "168h"),
  correlation = c(
    cor(features$p6.l0.dratesum_duration.avoid.yes, features$p6.l0.dratesum_duration.avoid.no),
    cor(features$p12.l0.dratesum_duration.avoid.yes, features$p12.l0.dratesum_duration.avoid.no),
    cor(features$p24.l0.dratesum_duration.avoid.yes, features$p24.l0.dratesum_duration.avoid.no),
    cor(features$p48.l0.dratesum_duration.avoid.yes, features$p48.l0.dratesum_duration.avoid.no),
    cor(features$p72.l0.dratesum_duration.avoid.yes, features$p72.l0.dratesum_duration.avoid.no),
    cor(features$p168.l0.dratesum_duration.avoid.yes, features$p168.l0.dratesum_duration.avoid.no)
  )
)

cat("Correlation between DIFFERENCE 'avoid.yes' and 'avoid.no' rates\n\n")
print(cor_table)
```

## NZV

Based on the requirements of `step_nzv()`:
```{r}
?step_nzv
```

"This step diagnoses predictors that have one unique value (i.e. are zero variance predictors) or predictors that have both of the following characteristics:

1) they have very few unique values relative to the number of samples and

2) the ratio of the frequency of the most common value to the frequency of the second most common value is large."

Check unique values relative to number of samples. `unique_cut` default is 10.
```{r}
p_unique <- function(var_name, d){
  
  length(unique(d[[var_name]]))/nrow(d)*100
  
}

p <- names(features) |> 
  map(\(var_name) p_unique(var_name, features)) |> 
  cbind()
```

Check ratio frequency. `freq_cut` default is 95/5.
```{r}
p_freq <- function(var_name, d){
  t <- d |> 
      janitor::tabyl({{var_name}}) |> 
      arrange(desc(n))
 
  t$n[1]/t$n[2] 
}

f <- names(features) |> 
  map(\(var_name) p_freq(var_name, features)) |> 
  cbind()
```

### Save out to shared folder
```{r}
features |>
  write_csv(here::here(path_shared, str_c("features_", params$sample, "_",
                                       params$window, "_",
                                       params$roll_dur, "h.csv")))
```
---
title: "EDA of CHTC features - Modeling"
author: "Claire Punturieri"
date: "`r lubridate::today()`"
format: 
  html:
    toc: true
    toc_depth: 4
    embed-resources: true
editor_options: 
  chunk_output_type: console
params:
  window: "day"
  roll_dur: 1 # 1 24
  sample: "gps" # ema messages
---

# Housekeeping

## Code Status

In progress 2/2026.

## Notes

 - Perhaps want a feature that captures alcohol not at home or at work, maybe the presence of alcohol is more meaningful when someone does not expect it?
 - Is there value in dropping the "other" category?
 - What about drinking at a location where alcohol is not available? Is that qualitatively more meaningful and a riskier behavior that we want to assign greater weight to?

# Set up

## Set up environment basics

```{r}
#| message: false
#| warning: false

library(tidyverse)
library(tidymodels)

options(conflicts.policy = "depends.ok")
```

## Paths

```{r}
source("https://github.com/jjcurtin/lab_support/blob/main/format_path.R?raw=true")

features_file <- str_c("features_", params$sample, "_", params$window, "_", params$roll_dur, "h.csv")

path_shared <- format_path("risk/data_processed/shared")
```

## Additional packages and source

```{r}
#| message: false
#| warning: false
#| echo: false

# helpful lab functions
source("https://github.com/jjcurtin/lab_support/blob/main/fun_eda.R?raw=true")

# adjust plot visuals
theme_set(theme_classic())
options(tibble.width = Inf, dplyr.print_max = Inf)
```

## Load in data

Load in features data and strat data -- these are combined formally in mak_combined_features.qmd but is reproduced below for simplicity.
```{r}
features <- read_csv(here::here(path_shared, features_file), 
                 show_col_types = FALSE)

strat <- read_csv(here::here(path_shared, "strat_lh.csv"), 
                    show_col_types = FALSE)

all <- left_join(features, strat, by = c("subid"))
```

Take eyeball sample stratified on participants who are high and low lapse.
```{r}
set.seed(20211121)
eyeball <- all |>
  select(-contains("pass_poi"), -contains("entropy"),
         -contains("var_location"), -contains("adi_cats")) |> 
  group_initial_split(group = subid, prop = .10, strata = strat) |>
  analysis()

eyeball_raw <- eyeball |> select(subid, dttm_label, lapse, contains("l0.r"), strat)
  
eyeball_diff <- eyeball |> select(subid, dttm_label, lapse, contains("l0.d"), strat)
```

## EDA - Location

```{r}
locations <- read_csv(here::here(path_shared, "locations.csv"),
                      show_col_types = FALSE) |> 
  filter(subid %in% features$subid) # filter down to subjects we are using

#loc_eyeball <- locations |> 
  #filter(subid %in% eyeball$subid)
```

```{r}
locations |>
  tab2(type, alcohol)
```

Pleasant doesn't mean protective. Family, friends, and bars are often rated as "pleasant", but folks have often drank in those settings before.
```{r}
locations |> 
  tab2(type, emotion)
```

```{r}
locations |> 
  tab2(type, drank)
```

```{r}
locations |> 
  tab2(type, risk)
```

```{r}
locations |> 
  tab2(type, avoid)
```

Is spending time at a location where you have drank somewhere where alcohol is not available more meaningful? (E.g., you have to bring your own?)
```{r}
locations |> 
  tab2(drank, alcohol)

locations |> 
  filter(alcohol == "no") |> 
  tab2(drank, alcohol)

locations |> 
  filter(alcohol == "yes") |> 
  tab2(drank, alcohol)
```

What about being at a location where you have drank before which you also want to avoid, is that more important?
```{r}
locations |> 
  tab2(alcohol, avoid)

locations |> 
  filter(drank == "no") |> 
  tab2(alcohol, avoid)

locations |> 
  filter(drank == "yes") |> 
  tab2(alcohol, avoid)
```

```{r}
locations |> 
  tab2(alcohol, risk)
```

Let's look specifically at the relationship between work and home and other location characteristics.
```{r}
locations |> 
  filter(type == "home" | type == "work") |> 
  pivot_longer(
    cols = c(alcohol, avoid, risk, drank, emotion),
    names_to = "variable",
    values_to = "value"
  ) |> 
  count(variable, type, value) |> 
  group_by(variable, type) |> 
  mutate(rate = n/sum(n))
```

What about homes of friends and family?
```{r}
locations |> 
  filter(type == "friend" | type == "family") |> 
  pivot_longer(
    cols = c(alcohol, avoid, risk, drank, emotion),
    names_to = "variable",
    values_to = "value"
  ) |> 
  count(variable, type, value) |> 
  group_by(variable, type) |> 
  mutate(rate = n/sum(n))
```

## EDA - Raw Features

### Alcohol at frequent places

Time spent at home, work, and the presence of alcohol are all related.

Relationship between time spent at home and alcohol.
```{r}
eyeball_raw |> 
  select(contains("type.home"), contains("alcohol.yes")) |>
  cor(use = "pairwise.complete.obs") |> 
  corrplot::corrplot.mixed()
```

Relationship between time spent at work and alcohol.
```{r}
eyeball_raw |> 
  select(contains("type.work"), contains("alcohol.yes")) |>
  cor(use = "pairwise.complete.obs") |> 
  corrplot::corrplot.mixed()
```

### High risk locations and emotions

Relationship between risk high and emotion unpleasant. -- Not correlated?
```{r}
eyeball_raw |> 
  select(contains("risk.high"), contains ("emotion.unpleasant")) |> 
  cor(use = "pairwise.complete.obs") |> 
  corrplot::corrplot.mixed()
```

High risk and mixed emotions are highly correlated. Maybe high risk locations are more likely to have mixed emotions? (E.g., I go out with my friends who I really enjoy, but I know they will pressure me to drink)
```{r}
eyeball_raw |> 
  select(contains("risk.high"), contains ("emotion.mixed")) |> 
  cor(use = "pairwise.complete.obs") |> 
  corrplot::corrplot.mixed()
```

Higher risk places and pleasant emotions are inversely correlated, makes sense.
```{r}
eyeball_raw |> 
  select(contains("risk.high"), contains ("emotion.pleasant")) |> 
  cor(use = "pairwise.complete.obs") |> 
  corrplot::corrplot.mixed()
```

### Home and temp residence
```{r}
eyeball_raw |> 
  select(contains("temporaryresidence"), contains("type.home")) |> 
  cor(use = "pairwise.complete.obs") |> 
  corrplot::corrplot.mixed()
```

### Healthy behaviors and emotions

```{r}
eyeball_raw |> 
  select(contains("fitness"), contains ("emotion.neutral")) |> 
  cor(use = "pairwise.complete.obs") |> 
  corrplot::corrplot.mixed()
```

```{r}
eyeball_raw |> 
  select(contains("aa"), contains ("emotion.pleasant")) |> 
  cor(use = "pairwise.complete.obs") |> 
  corrplot::corrplot.mixed()
```

```{r}
eyeball_raw |> 
  select(contains("healthcare"), contains ("emotion.neutral")) |> 
  cor(use = "pairwise.complete.obs") |> 
  corrplot::corrplot.mixed()
```

### Social support and emotions

```{r}
eyeball_raw |> 
  select(contains("friend"), contains("emotion.pleasant")) |> 
  cor(use = "pairwise.complete.obs") |> 
  corrplot::corrplot.mixed()
```

```{r}
eyeball_raw |> 
  select(contains("family"), contains("emotion.pleasant")) |> 
  cor(use = "pairwise.complete.obs") |> 
  corrplot::corrplot.mixed()
```

### Most correlated features

```{r}
patterns <- c("type.aa", "type.airport", "type.bar", "type.cafe",
              "type.church", "type.communityspacerecreation",
              "type.errands", "type.family", "type.fitness", "type.friend",
              "type.healthcare", "type.home", "type.library",
              "type.liquorstore", "type.other", "type.park",
              "type.publicdrinkingspace", "type.restaurant", "type.school",
              "type.temporaryresidence", "type.travelstop", "type.volunteer",
              "type.work", "drank.yes", "drank.no", "alcohol.yes", "alcohol.no",
              "emotion.pleasant", "emotion.unpleasant", "emotion.mixed",
              "emotion.neutral", "risk.high", "risk.medium", "risk.low",
              "risk.no", "avoid.yes", "avoid.no", "transit.yes", "transit.no",
              "evening_out.yes", "evening_out.no", "home.yes", "home.no")
```

```{r}
cor_long <- eyeball_raw |> 
  select(-strat, -subid, -dttm_label, -lapse) |> 
  cor(use = "pairwise.complete.obs") |>
  as.data.frame() |>
  rownames_to_column("var1") |>
  pivot_longer(-var1, names_to = "var2", values_to = "correlation") |>
  filter(var1 < var2)

cor_filtered <- cor_long |>
  rowwise() |>
  mutate(shared_pattern = any(
    sapply(patterns, function(p)
      str_detect(var1, p) & str_detect(var2, p)
    )
  )) |>
  ungroup() |>
  filter(!shared_pattern) |>
  select(-shared_pattern) |> 
  arrange(desc(abs(correlation)))

head(cor_filtered, 10)

```

### Relationships with lapse count

#### Emotions

```{r}
eyeball_raw |> 
  select(contains("emotion.pleasant"), contains("strat")) |>
  mutate(strat = if_else(strat == "low lapse", 0, 1)) |> 
  cor(use = "pairwise.complete.obs") |> 
  corrplot::corrplot.mixed()
```

```{r}
eyeball_raw |> 
  select(contains("emotion.unpleasant"), contains("strat")) |>
  mutate(strat = if_else(strat == "low lapse", 0, 1)) |> 
  cor(use = "pairwise.complete.obs") |> 
  corrplot::corrplot.mixed()
```

```{r}
eyeball_raw |> 
  select(contains("emotion.neutral"), contains("strat")) |>
  mutate(strat = if_else(strat == "low lapse", 0, 1)) |> 
  cor(use = "pairwise.complete.obs") |> 
  corrplot::corrplot.mixed()
```

```{r}
eyeball_raw |> 
  select(contains("emotion.mixed"), contains("strat")) |>
  mutate(strat = if_else(strat == "low lapse", 0, 1)) |> 
  cor(use = "pairwise.complete.obs") |> 
  corrplot::corrplot.mixed()
```

#### Risk

```{r}
eyeball_raw |> 
  select(contains("risk.high"), contains("strat")) |>
  mutate(strat = if_else(strat == "low lapse", 0, 1)) |> 
  cor(use = "pairwise.complete.obs") |> 
  corrplot::corrplot.mixed()
```

```{r}
eyeball_raw |> 
  select(contains("risk.medium"), contains("strat")) |>
  mutate(strat = if_else(strat == "low lapse", 0, 1)) |> 
  cor(use = "pairwise.complete.obs") |> 
  corrplot::corrplot.mixed()
```

```{r}
eyeball_raw |> 
  select(contains("risk.low"), contains("strat")) |>
  mutate(strat = if_else(strat == "low lapse", 0, 1)) |> 
  cor(use = "pairwise.complete.obs") |> 
  corrplot::corrplot.mixed()
```

```{r}
eyeball_raw |> 
  select(contains("risk.no"), contains("strat")) |>
  mutate(strat = if_else(strat == "low lapse", 0, 1)) |> 
  cor(use = "pairwise.complete.obs") |> 
  corrplot::corrplot.mixed()
```

#### Alcohol

```{r}
eyeball_raw |> 
  select(contains("alcohol.no"), contains("strat")) |>
  mutate(strat = if_else(strat == "low lapse", 0, 1)) |> 
  cor(use = "pairwise.complete.obs") |> 
  corrplot::corrplot.mixed()
```

```{r}
eyeball_raw |> 
  select(contains("alcohol.yes"), contains("strat")) |>
  mutate(strat = if_else(strat == "low lapse", 0, 1)) |> 
  cor(use = "pairwise.complete.obs") |> 
  corrplot::corrplot.mixed()
```

#### Avoid

```{r}
eyeball_raw |> 
  select(contains("avoid.yes"), contains("strat")) |>
  mutate(strat = if_else(strat == "low lapse", 0, 1)) |> 
  cor(use = "pairwise.complete.obs") |> 
  corrplot::corrplot.mixed()
```

```{r}
eyeball_raw |> 
  select(contains("avoid.no"), contains("strat")) |>
  mutate(strat = if_else(strat == "low lapse", 0, 1)) |> 
  cor(use = "pairwise.complete.obs") |> 
  corrplot::corrplot.mixed()
```

#### Time spent at home

```{r}
eyeball_raw |> 
  select(contains("type.home"), contains("strat")) |>
  mutate(strat = if_else(strat == "low lapse", 0, 1)) |> 
  cor(use = "pairwise.complete.obs") |> 
  corrplot::corrplot.mixed()
```

#### Time spent outside of the home in the evening

```{r}
eyeball_raw |> 
  select(contains("evening_out.yes"), contains("strat")) |>
  mutate(strat = if_else(strat == "low lapse", 0, 1)) |> 
  cor(use = "pairwise.complete.obs") |> 
  corrplot::corrplot.mixed()
```

```{r}
eyeball_raw |> 
  select(contains("evening_out.no"), contains("strat")) |>
  mutate(strat = if_else(strat == "low lapse", 0, 1)) |> 
  cor(use = "pairwise.complete.obs") |> 
  corrplot::corrplot.mixed()
```

#### Highest correlation with lapse count

```{r}
strat_cor <- eyeball_raw |> 
  select(-lapse, -subid, -dttm_label) |> 
  mutate(strat = if_else(strat == "low lapse", 0, 1)) |> 
  summarise(across(-strat, 
                   ~ cor(.x, strat, use = "complete.obs"))) |> 
  pivot_longer(everything(),
               names_to = "variable",
               values_to = "correlation") |> 
  arrange(desc(abs(correlation)))


strat_cor |> head(n = 20)
```

## EDA - Difference Features

Maybe consider adding this in? More difficult to interpret.
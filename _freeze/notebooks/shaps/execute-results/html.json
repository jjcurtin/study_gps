{
  "hash": "f55452e7f931f3b8c665849d391b35e7",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"SHAPs\"\nauthor: \"John Curtin, modified by Claire Punturieri\"\ndate: \"2024-10-23\"\noutput: \n  html_document:\n    toc: true \n    toc_depth: 4\nformat:\n  html:\n    embed-resources: true\nparams:\n  study: \"gps\"\n  window: \"1day\"\n  version: \"v6\"\n  cv: \"nested_1_x_10_3_x_10\"\n  algorithms: \"xgboost\"   # \"all\" or name of specific algorithm\n  model: \"main\"\neditor_options: \n  chunk_output_type: console\n---\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nstudy <- params$study\ncv <- params$cv\nalgorithms <- params$algorithms\nversion <- params$version\nwindow <- params$window\nmodel <- params$model\n```\n:::\n\n\n\n# Set up environment\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nlibrary(tidyverse)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──\n✔ dplyr     1.1.4     ✔ readr     2.1.5\n✔ forcats   1.0.0     ✔ stringr   1.5.1\n✔ ggplot2   3.5.1     ✔ tibble    3.2.1\n✔ lubridate 1.9.3     ✔ tidyr     1.3.1\n✔ purrr     1.0.2     \n── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──\n✖ dplyr::filter() masks stats::filter()\n✖ dplyr::lag()    masks stats::lag()\nℹ Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\ntheme_set(theme_classic()) \ndevtools::source_url(\"https://github.com/jjcurtin/lab_support/blob/main/format_path.R?raw=true\",\n                     sha1 = \"a58e57da996d1b70bb9a5b58241325d6fd78890f\")\npath_models <- format_path(str_c(\"studydata/risk/models/\", study))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n#source(here::here(path_mak, \"mak_ema_shaps.R\"))\n\nshaps <- read_rds(file.path(path_models, str_c(\"inner_shaps_\", \n                                           window, \"_\", version, \"_\", \n                                           cv, \"_\", model, \".rds\"))) |>\n  #pivot_longer(cols = starts_with(\"prob\"), \n               #names_to = \"method\", \n               #values_to = \".pred_Lapse\") |>\n  glimpse()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 4,173,193\nColumns: 5\nGroups: id_obs [11,511]\n$ id_obs     <int> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…\n$ variable   <fct> p168.raw_duration.risk.medium, p6.diff_duration.risk.high, …\n$ value      <dbl> -0.222449977, -0.022518206, 0.039494187, 0.073705416, 0.085…\n$ rfvalue    <dbl> 0.000000000, -0.001160714, 0.001160714, 0.000000000, 0.0434…\n$ mean_value <dbl> 0.181355553, 0.043778063, 0.167258377, 0.093508345, 0.10053…\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\nshaps_grp <- read_rds(file.path(path_models, str_c(\"inner_shapsgrp_\", \n                                           window, \"_\", version, \"_\", \n                                           cv, \"_\", model, \".rds\"))) |>\n  #pivot_longer(cols = starts_with(\"prob\"), \n               #names_to = \"method\", \n               #values_to = \".pred_Lapse\") |>\n  glimpse()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 103,599\nColumns: 3\nGroups: id_obs [11,511]\n$ id_obs       <int> 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 3, …\n$ variable_grp <fct> alcohol availability at location, location to avoid in re…\n$ value        <dbl> 0.112337563, -0.017883652, 0.004709006, -0.001830503, 0.0…\n```\n\n\n:::\n:::\n\n::: {#cell-fig-shaps-group .cell}\n\n```{.r .cell-code .hidden}\n#| label: fig-shaps-group\n#| fig-cap: Grouped SHAP values displaying relative feature importance calculated using mean absolute values. Larger log-odds values indicate greater contribution to predictions in the model.\n#| fig-height: 5\n#| fig-width: 5\n\nshaps_grp |>\n  group_by(variable_grp) |>\n  summarize(mean_value = (mean(abs(value)))) |> \n  mutate(group = reorder(variable_grp, mean_value)) |> #, sum)) |>\n  #mutate(window = fct(window, levels = c(\"week\", \"day\", \"hour\"))) |> \n  ggplot() +\n  geom_bar(aes(x = group, y = mean_value), stat = \"identity\", fill = \"#af1f21\") +\n  ylab(\"Mean |SHAP| value (in Log-Odds)\") +\n  xlab(\"\") +\n  coord_flip()\n```\n\n::: {.cell-output-display}\n![Grouped SHAP values displaying relative feature importance calculated using mean absolute values. Larger log-odds values indicate greater contribution to predictions in the model.](shaps_files/figure-html/fig-shaps-group-1.png){#fig-shaps-group width=480}\n:::\n:::",
    "supporting": [
      "shaps_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
    <meta charset="utf-8">
    <meta name="generator" content="quarto-1.5.57">

    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

    <meta name="author" content="Claire Punturieri">

    <title>Study GPS Notes</title>
    <style>
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      div.columns{display: flex; gap: min(4vw, 1.5em);}
      div.column{flex: auto; overflow-x: auto;}
      div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
      ul.task-list{list-style: none;}
      ul.task-list li input[type="checkbox"] {
        width: 0.8em;
        margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
        vertical-align: middle;
      }
    </style>

    <style>
      body.hypothesis-enabled #quarto-embed-header {
        padding-right: 36px;
      }

      #quarto-embed-header {
        height: 3em;
        width: 100%;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: solid 1px;
      }

      #quarto-embed-header h6 {
        font-size: 1.1em;
        padding-top: 0.6em;
        margin-left: 1em;
        margin-right: 1em;
        font-weight: 400;
      }

      #quarto-embed-header a.quarto-back-link,
      #quarto-embed-header a.quarto-download-embed {
        font-size: 0.8em;
        margin-top: 1em;
        margin-bottom: 1em;
        margin-left: 1em;
        margin-right: 1em;
      }

      .quarto-back-container {
        padding-left: 0.5em;
        display: flex;
      }

      .headroom {
          will-change: transform;
          transition: transform 200ms linear;
      }

      .headroom--pinned {
          transform: translateY(0%);
      }

      .headroom--unpinned {
          transform: translateY(-100%);
      }      
    </style>

    <script>
    window.document.addEventListener("DOMContentLoaded", function () {

      var header = window.document.querySelector("#quarto-embed-header");
      const titleBannerEl = window.document.querySelector("body > #title-block-header");
      if (titleBannerEl) {
        titleBannerEl.style.paddingTop = header.clientHeight + "px";
      }
      const contentEl = window.document.getElementById('quarto-content');
      for (const child of contentEl.children) {
        child.style.paddingTop = header.clientHeight + "px";
        child.style.marginTop = "1em";
      }

      // Use the article root if the `back` call doesn't work. This isn't perfect
      // but should typically work
      window.quartoBackToArticle = () => {
        var currentUrl = window.location.href;
        window.history.back();
        setTimeout(() => {
            // if location was not changed in 100 ms, then there is no history back
            if(currentUrl === window.location.href){              
                // redirect to site root
                window.location.href = "index.html";
            }
        }, 100);
      }

      const headroom = new window.Headroom(header, {
        tolerance: 5,
        onPin: function () {
        },
        onUnpin: function () {
        },
      });
      headroom.init();
    });
    </script>

    
<script src="site_libs/manuscript-notebook/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
     
      </head>

  <body class="quarto-notebook">
    <div id="quarto-embed-header" class="headroom fixed-top bg-primary">
      
      <a onclick="window.quartoBackToArticle(); return false;" class="btn btn-primary quarto-back-link" href=""><i class="bi bi-caret-left"></i> Back to Article</a>
      <h6><i class="bi bi-journal-code"></i> Study GPS Notes</h6>

            <a href="./study_notebook.qmd" class="btn btn-primary quarto-download-embed" download="study_notebook.qmd">Download Source</a>
          </div>

     <header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Study GPS Notes</h1>
          </div>

    
    <div class="quarto-title-meta-container">
      <div class="quarto-title-meta-column-start">
        
        <div class="quarto-title-meta">

                <div>
            <div class="quarto-title-meta-heading">Author</div>
            <div class="quarto-title-meta-contents">
                        <p>Claire Punturieri </p>
                      </div>
          </div>
                
          
                
              </div>
      </div>
      <div class="quarto-title-meta-column-end quarto-other-formats-target">
      </div>
    </div>



    <div class="quarto-other-links-text-target">
    </div>  </div>
</header><div id="quarto-content" class="page-columns page-rows-contents page-layout-article toc-left">
<div id="quarto-sidebar-toc-left" class="sidebar toc-left">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#housekeeping" id="toc-housekeeping" class="nav-link active" data-scroll-target="#housekeeping">Housekeeping</a>
  <ul class="collapse">
  <li><a href="#notes" id="toc-notes" class="nav-link" data-scroll-target="#notes">Notes</a></li>
  <li><a href="#to-donext-steps" id="toc-to-donext-steps" class="nav-link" data-scroll-target="#to-donext-steps">To do/next steps</a></li>
  </ul></li>
  <li><a href="#file-storage" id="toc-file-storage" class="nav-link" data-scroll-target="#file-storage">File storage</a>
  <ul class="collapse">
  <li><a href="#pre-processing" id="toc-pre-processing" class="nav-link" data-scroll-target="#pre-processing">Pre-processing</a></li>
  <li><a href="#feature-engineering" id="toc-feature-engineering" class="nav-link" data-scroll-target="#feature-engineering">Feature engineering</a></li>
  <li><a href="#modeling" id="toc-modeling" class="nav-link" data-scroll-target="#modeling">Modeling</a></li>
  <li><a href="#model-evaluation" id="toc-model-evaluation" class="nav-link" data-scroll-target="#model-evaluation">Model evaluation</a></li>
  </ul></li>
  <li><a href="#feature-engineering-1" id="toc-feature-engineering-1" class="nav-link" data-scroll-target="#feature-engineering-1">Feature engineering</a></li>
  <li><a href="#modeling-1" id="toc-modeling-1" class="nav-link" data-scroll-target="#modeling-1">Modeling</a></li>
  <li><a href="#presenting" id="toc-presenting" class="nav-link" data-scroll-target="#presenting">Presenting</a></li>
  <li><a href="#writing" id="toc-writing" class="nav-link" data-scroll-target="#writing">Writing</a></li>
  </ul>
</nav>
</div>
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
</div>
<main class="content quarto-banner-title-block" id="quarto-document-content">      

       <section id="housekeeping" class="level1">
<h1>Housekeeping</h1>
<section id="notes" class="level2">
<h2 class="anchored" data-anchor-id="notes">Notes</h2>
<p>Last updated 9/10/2025.</p>
<p>Note that there will be some overlap between model and feature versions.</p>
</section>
<section id="to-donext-steps" class="level2">
<h2 class="anchored" data-anchor-id="to-donext-steps">To do/next steps</h2>
<ul>
<li><p>Calculate CM features</p></li>
<li><p>Run comparative models (AKA: does CM add anything?)</p></li>
</ul>
</section>
</section>
<section id="file-storage" class="level1">
<h1>File storage</h1>
<p>This section details where different data are stored relating to the GPS study.</p>
<section id="pre-processing" class="level2">
<h2 class="anchored" data-anchor-id="pre-processing">Pre-processing</h2>
<ol type="1">
<li><p>_eda/eda_gps.qmd –&gt; understand GPS data quality, rule out subjects with poor compliance</p></li>
<li><p>_eda/eda_context.qmd –&gt; decide filtering thresholds for GPS data</p></li>
<li><p>_mak/mak_circadian.qmd –&gt; quantify circadian stability from clustered GPS data</p></li>
</ol>
</section>
<section id="feature-engineering" class="level2">
<h2 class="anchored" data-anchor-id="feature-engineering">Feature engineering</h2>
<ol type="1">
<li><p>proj_risk/shared/scripts_chtc is where gps and weather feature scripts can be found</p></li>
<li><p>_mak/mak_combined_features.qmd –&gt; pulls together separate feature files and collates them to be used for making predictions</p></li>
<li><p><strong>All FEATURES after being run on CHTC can be found in risk/chtc/shared</strong></p></li>
</ol>
</section>
<section id="modeling" class="level2">
<h2 class="anchored" data-anchor-id="modeling">Modeling</h2>
<ol type="1">
<li><p>_chtc/mak_jobs.R</p></li>
<li><p>_chtc/training_controls_gps.R</p></li>
<li><p><strong>All MODELS after being run on CHTC can be found in risk/chtc/gps</strong></p></li>
</ol>
</section>
<section id="model-evaluation" class="level2">
<h2 class="anchored" data-anchor-id="model-evaluation">Model evaluation</h2>
<ol type="1">
<li><p>_mak/mak_best_config.qmd –&gt; aggregates results from all batches, runs some checks, and saves out best model configuration</p></li>
<li><p>_mak/mak_local_preds.qmd –&gt;generate predicted probabilities from best model configuration</p></li>
<li><p>_ana/ana_probs.qmd –&gt; takes predicted probabilities and makes some nice figures for visualizing how well a model is calibrated</p></li>
</ol>
</section>
</section>
<section id="feature-engineering-1" class="level1">
<h1>Feature engineering</h1>
<p>July/August 2025</p>
<ul>
<li><p>Finalized generation of circadian movement data! Data are saved out and ready for action.</p></li>
<li><p>Made weather feature scripts generalizable and published to GitHub.</p></li>
</ul>
<p>7/1/2025</p>
<ul>
<li><p>Generated spectra for each subject while on study. Saved in risk/data_processed/gps. Need to check to make sure these are set to the same scale.</p></li>
<li><p>Might need to consider interpolating GPS data. Pulled some information and put it in the mak_circadian file.</p></li>
<li><p>Before interpolating, will check out k-means approach to identifying location clusters. That might clean up the data enough.</p></li>
</ul>
<p>Week of 6/23/2025</p>
<ul>
<li><p>Need to figure out what threshold of missing data to tolerate when doing CM calculations. lsp() function only needs 3 data points but we definitely need more than that to accurately calculate spectra. Currently have the threshold set to 42 (which would be about a sample every 4 hours). Biological rhythms research is sparse on this, but the conclusion seems to be “the more the better”!</p></li>
<li><p>Aligned data to start for all subjects at midnight on day two of participation so rhythms are aligned.</p></li>
</ul>
<p>6/18/2025</p>
<ul>
<li><p>Created a new file which combines gps features, weather features, and the stratification file to create a combine features file. This file is in data_processed/gps. Eventually will need to add in circadian movement.</p></li>
<li><p>Worked more on processing circadian movement. Turns out there’s only about 3% of missing data, and there are certain subjects who have more missing data than others. Next step is to explore interpolation options or potentially nixing some subjects.</p></li>
</ul>
<p>6/17/2025</p>
<ul>
<li><p>Was concerned about some very cold weather variables (avgt of -18!) so manually queried using RCC-ACIS. Looks like these values are correct and it was just a cold January in 2019.</p></li>
<li><p>Circadian movement processing needs closer inspection. Need to first assess how much missing data there is and then figure out an imputation strategy.</p></li>
</ul>
<p>6/11/2025</p>
<ul>
<li><p>After rerunning GPS features on 6/10 (v6), noticed that community space / recreation, public drinking space, temporary residence, and travel stop all have 0s for p0 p50 p100 – I suspect this has to do with spacing in variable names. I checked and this was also the case with the previous version of features, so I’m also guessing this hasn’t been caught before. Confirmed has to do with spacing.</p></li>
<li><p>V7 GPS features were checked and saved out. Now there are no features that are all 0s!</p></li>
<li><p>Weather features were generated (generated very fast so ask John about how to string batches together better so CHTC doesn’t get mad at me). The features look fine, but there are some very low temps (checked in the weather raw file and confirmed those exist so it’s not a calculation error). Note to manually check the weather for some of those days as a sanity check.</p></li>
</ul>
<p>Past 1hr roll feature versions:</p>
<ul>
<li><p>V6:</p></li>
<li><p>V5:</p></li>
<li><p>V4:</p></li>
<li><p>V3:</p></li>
<li><p>V2:</p></li>
<li><p>V1:</p></li>
<li><p>For 24hr roll feature documentation, see GitHub.</p></li>
</ul>
</section>
<section id="modeling-1" class="level1">
<h1>Modeling</h1>
<p>7/22/2025</p>
<ul>
<li><p>Had the thought that maybe cal_estimate_beta() is modifying the inputs to beta_calibration() in some way prior to passing it into the function and perhaps that is why I am having difficulty replicating. Did some sleuthing and looks like this is the case. cal_estimate_beta() changes the outcome variable from a factor to numeric prior to passing it in to beta_calibration(). Adding that in to my code enables me to reproduce the error.</p></li>
<li><p>Finalized and published beta calibration reprex.</p></li>
</ul>
<p>7/21/2025</p>
<ul>
<li>While working on beta calibration reprex, noticed that I can’t replicate the same error I get in mak_local_preds. Not sure why this is. Started comparing all of the objects in my environment, they all look the same so unsure what the issue could be.</li>
</ul>
<p>Week of 7/14/2025</p>
<ul>
<li>Note to self that changed stationary training_controls file for V9 to match updated recipe. I don’t think this should impact anything because the main changes were removing label_num and changing strat_cv to just strat.</li>
<li>Started working in mak_local_preds and ana_probs to calibrate model. Model seems very uncalibrated! Note that beta calibration fails.</li>
<li>Chatted with John, established that a reprex needs to be made to understand what is causing beta calibration to fail. Started outlining reprex.</li>
</ul>
<p>7/3/2025</p>
<ul>
<li><p>GLMnet model may be fine, need to evaluate features.</p></li>
<li><p>Next steps will be to pull from scripts Madison and John wrote to evaluate xgboost model performance.</p></li>
</ul>
<p>7/2/2025</p>
<ul>
<li>GLMnet performance considerably worse (.659). Looks like there might be some issues with HP2? Ask John.</li>
</ul>
<p>7/1/2025</p>
<ul>
<li>Started running GLMnet (V10)</li>
</ul>
<p>Week of 6/23/2025</p>
<ul>
<li>auROC of model including weather features was not markedly improved (.742, about the same as improvements gained from adding stratification). Next steps will be to explore feature importance to assess utility of feature. First step is to run GLMnet and second step is to check calibration of XGBoost and look at SHAP values.</li>
</ul>
<p><br>
6/18/2025</p>
<ul>
<li><p>V9 model started, which includes hour roll features for GPS and weather and the stratification variable (low/high lapse counts).</p></li>
<li><p>Training controls file was updated in meeting with JC to 1) work across different model types; and 2) to anticipate taking in a features file which already includes the stratification variable.</p></li>
</ul>
<p>Model history prior to V9:</p>
<ul>
<li><p>V8: same V6/V7 features but testing out different forms of stratification</p></li>
<li><p>V7: Claire thought she made filtering changes but she accidentally didn’t, so is functionally the same as V6 :^) Oops!</p></li>
<li><p>V6: same model as V5 but updated features to roll by hour instead of by 24 hours</p></li>
<li><p>V5: recalculate preliminary context features (location variance, time in transit, time spent out of the house in the evening)</p></li>
<li><p>V4: add in preliminary context features (location variance, time in transit, time spent out of the house in the evening)</p></li>
<li><p>V3: remove pratesum features due to high missingness</p></li>
<li><p>V2: update context feature “type” with more information for values labeled other, expand mtry hyperparameter range downwards to include 10 and 15</p></li>
</ul>
</section>
<section id="presenting" class="level1">
<h1>Presenting</h1>
<p>April 2025:</p>
<ul>
<li><p>Poster presented at Society of Biological Psychiatry</p></li>
<li><p>Poster presented at Collaborative Perspectives on Addiction</p></li>
</ul>
<p>October 2024:</p>
<ul>
<li>First Year Project Symposium</li>
</ul>
</section>
<section id="writing" class="level1">
<h1>Writing</h1>
<p>October 2024:</p>
<ul>
<li>First Year Project final paper to committee</li>
</ul>
</section>
     </main>
<!-- /main column -->  <script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>  </div> <!-- /content --> 
  
</body></html>
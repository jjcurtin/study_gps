---
title: "Combining GPS & Demo Features"
author: "JJC, updated by Claire Punturieri"
date: "`r lubridate::today()`"
format: 
  html: 
    embed-resources: true
    toc: true 
    toc_depth: 4
editor_options: 
  chunk_output_type: console
---

## Notes


## Set up

```{r}
#| include: false

options(conflicts.policy = "depends.ok")
library(tidyverse) 

source("https://github.com/jjcurtin/lab_support/blob/main/format_path.R?raw=true")
source("https://github.com/jjcurtin/lab_support/blob/main/fun_eda.R?raw=true")
source("~/github/proj_risk/shared/fun_rename.R")
path_shared <- format_path("risk/data_processed/shared")
path_gps <- format_path("risk/data_processed/gps")
```

Read in feature files
```{r}
gps <- read_csv(here::here(path_shared, "features_gps_day_1h.csv"), 
                 show_col_types = FALSE) 
demos <- read_csv(here::here(path_shared, "features_demographics.csv"), 
                  show_col_types = FALSE)
aud_id <- read_csv(here::here(path_shared, "features_aud_id.csv"), 
                  show_col_types = FALSE)
weather <- read_csv(here::here(path_shared, "features_weather.csv"), 
                 show_col_types = FALSE)
cm <- read_csv(here::here(path_shared, "features_circadian.csv"),
               show_col_types = FALSE)
strat <- read_csv(here::here(path_shared, "strat_lh.csv"), 
                    show_col_types = FALSE) 
```

Check rows
```{r}
nrow(gps)
nrow(demos)
nrow(aud_id)
nrow(weather)
nrow(cm)
nrow(strat)
```

Verify expected # of subids

- GPS sample  for GPS, weather, and CM
- Full sample for demos
```{r}
gps |> distinct(subid) |> nrow() 
demos |> distinct(subid) |> nrow()
aud_id |> distinct(subid) |> nrow()
weather |> distinct(subid) |> nrow() 
cm |> distinct(subid) |> nrow() 
strat |> distinct(subid) |> nrow() 
```

Get rid of other features (e.g. no) that aren't useful, and remove Chris' features.
```{r}
gps <- gps |>
  # not useful
  select(-contains(".no")) |> 
  select(-contains("neutral")) |>
  select(-contains("other")) |> 
  # chris features
  select(-contains("poi_category")) |> 
  select(-contains("adi_cats"))
```

Clean feature names with John's function.
```{r}
gps <- gps |> 
  rename_gps_features_stage1() |> 
  reorder_feature_names(type = "gps")
```

Temporary cleaning of feature names, maybe integrate with John's code or just change how features are generated.
```{r}
# change passive gps features
gps <- gps |>
  rename_with(~ sub("^evening_out", "pass_evening_out", .x),
              starts_with("evening_out")) |>
  rename_with(~ sub("^location_var\\.raw", "pass_location_var.durraw", .x),
              starts_with("location_var.raw")) |>
    rename_with(~ sub("^location_var\\.dif", "pass_location_var.durdif", .x),
              starts_with("location_var.dif")) |>
  rename_with(~ sub("^transit", "pass_transit", .x),
              starts_with("transit"))

# change weather names
weather <- weather |> 
  rename_with(function(x) {
         
    x <- sub("(\\.snow|\\.pcpn)$", "", x)

    x <- gsub(
      "^p(\\d+)\\.l0\\.(r|d)([a-z]+)_([a-z0-9\\.]+)$",
      "pass_\\4.\\3\\2.p\\1",
      x
    )
    x <- sub("(\\.[a-z]+)r(\\.p\\d+)$", "\\1raw\\2", x)
    x <- sub("(\\.[a-z]+)d(\\.p\\d+)$", "\\1diff\\2", x)

    x <- sub("^p(\\d+)\\.l0\\.rratecount\\.([a-z0-9]+)$", 
             "pass_\\2.ratecountraw.p\\1", x)
    x <- sub("^p(\\d+)\\.l0\\.dratecount\\.([a-z0-9]+)$", 
             "pass_\\2.ratecountdiff.p\\1", x)

    x
  }) |> 
  rename_with(function(x) {

    x <- sub("^p(\\d+)\\.l0\\.rratecount\\.([a-z0-9_]+)$", 
             "pass_\\2.ratecountraw.p\\1", x)

    x <- sub("^p(\\d+)\\.l0\\.dratecount\\.([a-z0-9_]+)$", 
             "pass_\\2.ratecountdiff.p\\1", x)

    x
  }, starts_with("p"))


# change cm names
cm <- cm |>
  rename(
    pass_cm_recent.raw.p0 = p0.l0.rrecent_cm,
    pass_cm_recent.diff.p0 = p0.l0.drecent_cm
  )

# change id names
demos <- demos |> 
  rename_with(~ paste0("id_", .x), -1)

aud_id <- aud_id |> 
  rename_with(~ paste0("id_", .x), -1)
  
```
Remove diff features from monthly
```{r}
# monthly <- monthly |> 
#   select(-contains("drecent"))
```

Look at features for each signal

```{r}
names(gps)
names(demos)
names(aud_id)
names(weather)
names(cm)
names(strat)
```

Remove duplicated rows because of Daylight savings
Only needed for 24 hour rolls
```{r}
# ema <- ema |> distinct(subid, dttm_label, .keep_all = TRUE)
# gps <- gps |> distinct(subid, dttm_label, .keep_all = TRUE)
# monthly <- monthly |> distinct(subid, dttm_label, .keep_all = TRUE)
```


Join all files using left joins starting with GPS for that sample
Also join in strat lh
```{r}
all <- left_join(gps, demos, by = c("subid"))
nrow(all)

all <- left_join(all, strat, by = c("subid"))
nrow(all)

all <- left_join(all, aud_id, by = c("subid"))
nrow(all)

all <- left_join(all, weather, by = c("subid", "dttm_label", "lapse"))
nrow(all)

all <- left_join(all, cm, by = c("subid", "dttm_label", "lapse"))
nrow(all)
```

Check outcome.  Looks good!
```{r}
all |> tab(lapse) 
```

Write out file
```{r}
all |>
  select(subid, dttm_label, lapse,
         starts_with("id_"), everything()) |>
  select(-strat, strat) |> # want this to be at the end!!!
  write_csv(here::here(path_gps, 
                            str_c("features_combined.csv")))
```

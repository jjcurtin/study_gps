---
title: "Make enriched gps/location"
author: "John Curtin, updated by Claire Punturieri"
date: "`r lubridate::today()`"
format: 
  html:
    toc: true
    toc_depth: 4
    embed-resources: true
editor_options: 
  chunk_output_type: console
---

# Housekeeping

## Code Status

In progress has of 07/2024.

## Notes   

This script does EDA on the enriched GPS file, generated via mak_gps_enriched.qmd

# Set up

## Set up environment
```{r}
#| message: false
#| warning: false

options(conflicts.policy = "depends.ok")
devtools::source_url("https://github.com/jjcurtin/lab_support/blob/main/format_path.R?raw=true", 
                      sha1 = "a58e57da996d1b70bb9a5b58241325d6fd78890f")
```

## Paths
```{r}
path_shared <- format_path("studydata/risk/data_processed/shared")
path_gps <- format_path("studydata/risk/data_processed/gps")
```

## Packages and source
```{r}
#| message: false
#| warning: false

# for data wrangling
library(tidyverse)

# helpful lab functions
devtools::source_url("https://github.com/jjcurtin/lab_support/blob/main/fun_eda.R?raw=true",
 sha1 = "c045eee2655a18dc85e715b78182f176327358a7"
)

# adjust plot visuals
theme_set(theme_classic())
options(tibble.width = Inf, dplyr.print_max = Inf)
```

## Load in data
```{r}
enriched <- read_csv(here::here(path_gps, "gps_enriched.csv.xz"), 
                 show_col_types = FALSE)
```

# EDA

## Overview

Glimpse enriched data.
```{r}
enriched  |>   
  glimpse()
```

Check length of subids (verify it is the same as above).
```{r}
enriched  |>  
  pull(subid) |>
  unique() |>  
  length()
```

Create table summarizing number of unique `context_id` observations per subject.
```{r}
enriched |>
  group_by(subid) |>
  summarise(unique.context = n_distinct(context_id)) |> 
  print_kbl()
```

Display unique `context_id` observations per subject in a histogram.
```{r}
enriched |>
  group_by(subid) |>
  summarise(unique.context = n_distinct(context_id)) |>
  pull(unique.context) |> 
  hist(col = "white", border = "black",
       xlab = "# of Unique Context IDs", ylab = "Frequency",
       main = "Histogram of Unique Context IDs per Subject")
```

## Distance & duration

Look at spread of distance from last point.
```{r}
enriched |>
  filter(dist < 500) |> 
  ggplot(aes(x = dist)) +
  geom_histogram(color = "black", fill = "white") +
  xlab("Distance from last point (< 500m)")
```

Look at spread of duration.
```{r}
enriched |>
  filter(duration < 15) |> 
  ggplot(aes(x = duration)) +
  geom_histogram(color = "black", fill = "white") +
  xlab("Time since last point (< 15min)")
```

Look at spread of context distance.
```{r}
enriched |>
  filter(dist_context < 500) |> 
  ggplot(aes(x = dist_context)) +
  geom_histogram(color = "black", fill = "white") +
  xlab("Distance from closest known context (< 500m(")
```

Look at distance and duration directly before and after a 1-observation day.
```{r}
enriched_obs <- enriched |>
  group_by(subid, date) |>  
  summarise(n_obs = n())

enriched_obs |>
  filter(n_obs == 1)

# loop through one observation days for a given subject

# maybe match enriched and enriched_obs on subid and date?
# then can select points for one observation days
# then identify point before and after (row preceding and following)
```

## Examine missing data

Total number of missing variables per column.
```{r}
colSums(is.na(enriched))
```

Review of missing data for context. Can also look at cln_locations.qmd for further exploration. 
Omitting `vacation` here because we will likely not be using it.

- Type is missing for 110 for one location which accounts for all missing type in df
- Emotion missing for one entry of subids 3, 6, and 48
- Risk missing for an entry for subids 3, and 121.
```{r}
enriched[rowSums(is.na(enriched[, c("type", "drank", "alcohol", "emotion", "risk", "avoid")])) > 0, ] |>
  group_by(subid) |> 
  distinct(full_address, .keep_all = TRUE) |> 
  print_kbl()
```

## Summary by context

Summary of `type` responses.
```{r}
enriched  |>  tab(type)
```

Summary of `drank` responses.
```{r}
enriched  |>  tab(drank)
```

Summary of `alcohol` responses.
```{r}
enriched  |>  tab(alcohol)
```

Summary of `emotion` responses.
```{r}
enriched  |>  tab(emotion)
```

Summary of `risk` responses.
```{r}
enriched  |>  tab(risk)
```

Summary of `avoid` responses.
```{r}
enriched  |>  tab(avoid)
```

